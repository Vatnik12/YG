<!DOCTYPE html>
<html lang="ru" class="scroll-smooth">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>OneScreen План/Факт — by Vatnik</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'] },
          colors: { os: { primary: '#4f46e5' } },
          boxShadow: { soft:'0 10px 30px rgba(0,0,0,.06)' }
        }
      }
    }
  </script>

  <!-- Libs -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- NEW: основная библиотека экспорта -->
  <script src="https://unpkg.com/html-to-image@1.11.11/dist/html-to-image.js"></script>
  <!-- Fallback: html2canvas -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{ --ring:#e5e7eb }
    *{ scrollbar-width:thin; scrollbar-color:#CBD5E1 transparent }
    *::-webkit-scrollbar{ width:8px;height:8px }*::-webkit-scrollbar-thumb{ background:#CBD5E1;border-radius:9999px }

    .panel{ border:1px solid var(--ring); border-radius:14px; background:#fff; box-shadow:0 10px 30px rgba(0,0,0,.04)}
    .dark .panel{ background:#0b1220; border-color:#1f2937}

    .card{ position:relative; border:1px solid var(--ring); border-radius:14px; background:#0f172a; color:#e5e7eb }
    body.light .card{ background:#fff; color:#0f172a; border:1px solid #e5e7eb }

    .yg-chip,.yg-badge{
      display:inline-flex; align-items:center; gap:6px;
      height:26px; padding:0 10px; border-radius:9999px;
      font-size:12px; line-height:26px; vertical-align:middle; white-space:nowrap;
      transform: translateZ(0);
      will-change: transform;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }
    .yg-chip{ background:#0b1220; border:1px solid #23314f; color:#dbeafe }
    body.light .yg-chip{ background:#f1f5f9; border:1px solid #e2e8f0; color:#0f172a }
    .yg-badge{ color:#fff; }
    .badge-red{ background:#ef4444 } .badge-amber{ background:#f59e0b } .badge-slate{ background:#94a3b8 } .badge-blue{ background:#3b82f6 } .badge-emerald{ background:#10b981 }

    .title{
      font-weight:700; line-height:1.3; word-break:break-word; overflow-wrap:anywhere;
      transform: translateZ(0);
      will-change: transform;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }

    .mode-switch{ position:relative; border-radius:12px; border:1px solid var(--ring); background:rgba(99,102,241,.08); padding:4px; display:flex; gap:4px }
    .mode-thumb{ position:absolute; inset:4px auto 4px 4px; width:calc(50% - 6px); border-radius:8px; background:rgba(99,102,241,.18); transition:transform .25s ease }
    .mode-item{ position:relative; z-index:1; flex:1; padding:8px 10px; font-size:12px; border-radius:8px; display:flex; align-items:center; gap:6px; justify-content:center; cursor:pointer }
    .mode-item.inactive{ filter:saturate(.8) opacity(.65) }

    .theme-switch{ position:relative; width:64px; height:30px; border-radius:9999px; border:1px solid var(--ring); background:#eef2ff }
    .dark .theme-switch{ background:#0f172a; border-color:#1f2937 }
    .theme-thumb{ position:absolute; top:3px; left:3px; width:24px; height:24px; border-radius:9999px; background:#fff; transition:transform .25s ease, background .25s ease }
    .dark .theme-thumb{ background:#111827 }
    .theme-switch.on .theme-thumb{ transform:translateX(34px) }

    .drop-hover{ outline:3px dashed #4f46e5; outline-offset:-10px }

    /* SPLASH */
    #splash{ transition:opacity .6s ease, filter .6s ease }
    #splash.splash-hide{ opacity:0; filter:blur(8px) saturate(.9); pointer-events:none }

    /* Сцена рендера */
    #renderRoot{ position:relative; border-radius:16px; overflow:hidden; background:#fff }
    #renderRoot .bg-img{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; transform:scale(1.08) }
    #renderRoot.tower .bg-img{ transform:scale(1.45) }
    #renderRoot .bg-overlay{ position:absolute; inset:0; background:linear-gradient(180deg,rgba(15,23,42,.25),rgba(15,23,42,.25)) }
    #renderRoot .stage-pad{ position:relative; padding:24px }

    .kpi{ border-radius:14px; background:rgba(15,23,42,.8); border:1px solid rgba(148,163,184,.18); color:#e5e7eb; padding:18px 20px; min-width:150px }
    body.light .kpi{ background:rgba(241,245,249,.9); color:#0f172a; border-color:#dbeafe }
    .kpi .v{ font-size:28px; font-weight:800; line-height:1 }
    .kpi .t{ font-size:13px; opacity:.85 }

    /* === KPI компакт === */
    #topSummary{ --kpi-gap:8px; }
    #topSummary { gap: var(--kpi-gap) !important; }
    #topSummary .grid { gap: var(--kpi-gap) !important; }
    #topSummary .kpi{ padding:10px 12px !important; border-radius:10px !important; min-width:0; }
    #topSummary .kpi .v{ font-size:22px !important; line-height:1.1 !important; font-weight:800; }
    #topSummary .kpi .t{ font-size:11px !important; opacity:.75 !important; }
    #summaryTitle{ font-size:clamp(26px,2.6vw,38px) !important; line-height:1.12 !important; }
    #renderRoot.tower #topSummary{ display:grid !important; grid-template-columns:repeat(12,minmax(0,1fr)) !important; }
    #renderRoot.tower #topSummary>div{ display:initial !important; margin-bottom:0 !important; }
    #renderRoot.tower #topSummary .kpi{ width:auto !important; }

    /* Светлая тема */
    body.light{ background:#f7fafc; color:#0f172a; }
    body.light header > div,
    body.light footer > div {
      background:rgba(255,255,255,.85);
      border-color:#e5e7eb;
      -webkit-backdrop-filter:saturate(1.2) blur(8px);
      backdrop-filter:saturate(1.2) blur(8px);
    }
    body.light .panel{
      background:#ffffff;
      color:#0f172a;
      border-color:#e5e7eb;
      box-shadow:0 10px 30px rgba(2,6,23,.06);
    }
    body.light select.bg-slate-800{ background:#ffffff !important; color:#0f172a !important; border-color:#e2e8f0 !important; }
    body.light .text-slate-400{ color:#64748b !important; }
    #btnCopy{ border:1px solid rgba(255,255,255,.15); }
    body.light #btnCopy{ background:#0f172a !important; color:#ffffff !important; border-color:#0f172a !important; }
    body.light #renderRoot .bg-overlay{ background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.06)); }
    body.light .bg-slate-800{ background:#e5e7eb !important; }
    body.light .stage-pad .h-2{ background:#e5e7eb; }

    .icon-tile{ background:rgba(49,46,129,.15); color:#4338ca; }
    body.light .icon-tile{ background:#e2e8f0; color:#4338ca; }

    /* === Premium header controls ========================================== */
    .os-pill { border-radius:1rem; padding:.375rem .5rem; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1); font-size:.875rem; color:#cbd5e1; display:inline-flex; align-items:center; gap:.5rem; }
    body.light .os-pill { background:rgba(15,23,42,.04); border-color:#e2e8f0; color:#0f172a; }

    .os-seg { position:relative; border-radius:.75rem; border:1px solid rgba(255,255,255,.12); overflow:hidden; display:grid; }
    body.light .os-seg { border-color:#e2e8f0; }
    .os-seg .thumb{
      position:absolute; inset:.25rem auto .25rem .25rem;
      height:calc(100% - .5rem); border-radius:.5rem;
      background:rgba(255,255,255,.15);
      transition:transform .25s ease, width .25s ease;
    }
    .os-seg button{
      flex:1; min-width:38px; height:32px; /* было 34 */
      padding:0; display:flex; align-items:center; justify-content:center;
      font-size:13px; font-weight:500; border-radius:6px; position:relative; z-index:1; background:transparent;
    }
    body.light .os-seg button{ color:#334155; }

    /* активная кнопка — только цвет текста; ФОНА НЕТ */
    .os-seg button[data-active="true"]{ background:transparent !important; box-shadow:none !important; color:#fff; }
    body.light .os-seg button[data-active="true"]{ background:transparent !important; box-shadow:none !important; color:#0f172a; }

    /* Glass combobox */
    .os-combo{ position:relative; }
    .os-combo-btn{ composes: os-pill; }
    .os-combo-menu{
      position:absolute; right:0; margin-top:.5rem; width:14rem;
      border-radius:1rem; border:1px solid rgba(255,255,255,.12);
      background:rgba(2,6,23,.92); color:#e5e7eb;
      box-shadow:0 20px 40px rgba(0,0,0,.35);
      backdrop-filter:blur(10px); padding:.25rem; display:none;
    }
    body.light .os-combo-menu{ background:rgba(255,255,255,.96); color:#0f172a; border-color:#e2e8f0; }
    .os-combo-item{ width:100%; text-align:left; padding:.5rem .75rem; border-radius:.75rem; font-size:.875rem; }
    .os-combo-item:hover{ background:rgba(255,255,255,.08); }
    body.light .os-combo-item:hover{ background:#f1f5f9; }
    .os-combo.os-combo-open .os-combo-menu{ display:block; }

    /* Segmented control — компакт и один фон-источник */
    .os-seg{
      --seg-h: 32px;  /* было 34 */
      --seg-pad: 6px;
      --seg-gap: 10px;/* было 12 */
      display:flex; align-items:center; gap:var(--seg-gap); padding:var(--seg-pad);
      border-radius:12px; background:rgba(148,163,184,.08); box-shadow:inset 0 0 0 1px rgba(148,163,184,.25); box-sizing:border-box;
    }
    body.light .os-seg{ background:#f1f5f9; box-shadow:inset 0 0 0 1px #e2e8f0; }
    .os-seg button{ height:var(--seg-h); min-width:40px; padding:0 10px; display:flex; align-items:center; justify-content:center; border:0; border-radius:10px; box-sizing:border-box; background:transparent; font-size:13px; font-weight:500; line-height:1; color:#cbd5e1; cursor:pointer; }
    body.light .os-seg button{ color:#334155; }

    /* единственная light-строка для thumb */
    body.light .os-seg .thumb{ background:#e7eafc; box-shadow: inset 0 0 0 1px #c7cffc; }

    /* Combobox (ещё один стиль) */
    .os-combo{ position:relative }
    .os-combo-btn{ width:100%; display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border-radius:10px; background:rgba(148,163,184,.08); border:1px solid rgba(148,163,184,.25) }
    .os-combo-menu{ position:absolute; top:calc(100% + 6px); left:0; right:0; z-index:40; background:rgba(2,6,23,.9); border:1px solid rgba(148,163,184,.25); border-radius:12px; backdrop-filter:blur(10px); padding:6px; display:none }
    .os-combo.open .os-combo-menu{ display:block }
    .os-combo-item{ width:100%; text-align:left; padding:8px 10px; border-radius:8px; font-size:13px }
    .os-combo-item:hover{ background:rgba(99,102,241,.16) }
    body.light .os-combo-btn{ background:#fff; border-color:#e2e8f0 }
    body.light .os-combo-menu{ background:#fff }

    /* Muted-панель */
    .panel-muted{ background:transparent !important; color:#94a3b8 !important; border:1px dashed rgba(148,163,184,.35) !important }
    .panel-muted .chip{ background:rgba(148,163,184,.12); border:1px solid rgba(148,163,184,.25) }
  </style>
</head>
<body class="min-h-screen flex flex-col font-sans bg-slate-900 text-slate-100">

  <!-- SPLASH -->
  <div id="splash" class="fixed inset-0 z-50 grid place-items-center bg-[#0b1020]">
    <div class="relative w-full h-full overflow-hidden">
      <img src="./assets/bg.jpg" alt="" class="absolute inset-0 w-full h-full object-cover opacity-60"/>
      <div class="absolute inset-0 bg-gradient-to-b from-indigo-900/20 via-slate-900/30 to-slate-900/70"></div>
      <div class="relative h-full w-full flex items-center justify-center">
        <div class="text-center">
          <div class="inline-flex items-center gap-3 px-5 py-2 rounded-2xl bg-white/10 backdrop-blur ring-1 ring-white/20">
            <span class="text-white/90 font-semibold tracking-wide">OneScreen</span>
          </div>
          <h1 class="mt-5 text-3xl md:text-5xl font-extrabold text-white drop-shadow">План/Факт <span class="text-indigo-200">by Vatnik</span></h1>
          <p class="mt-3 text-white/80">Перетащи xlsx — получи красивый коллаж задач.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- HEADER -->
  <header class="sticky top-0 z-40">
    <div class="backdrop-blur bg-slate-900/70 border-b border-slate-800">
      <div class="max-w-[1200px] mx-auto px-4">
        <div class="py-4 md:py-5 flex flex-wrap items-stretch gap-3">
          <!-- Лого -->
          <div class="flex items-center gap-3 min-w-[220px]">
            <div class="w-10 h-10 rounded-2xl bg-indigo-600 grid place-items-center text-white font-bold">OS</div>
            <div class="leading-tight">
              <div class="font-semibold text-lg">OneScreen: План/Факт</div>
              <div id="modeBadge" class="text-xs text-slate-400">режим не выбран</div>
            </div>
          </div>

          <!-- Контролы -->
          <div class="flex flex-wrap items-stretch gap-2 flex-1">
            <!-- Колонки: сегменты -->
            <div class="panel px-3 py-2 min-w-[220px]">
              <div class="flex items-center justify-between">
                <span class="text-xs text-slate-400">Колонки</span>
                <select id="colSelect" class="hidden">
                  <option value="2">2</option><option value="3">3</option><option value="4">4</option>
                </select>
              </div>
              <div id="segCols" class="mt-2 os-seg grid grid-cols-3">
                <span class="thumb"></span>
                <button data-value="2" data-active="true">2</button>
                <button data-value="3">3</button>
                <button data-value="4">4</button>
              </div>
            </div>

            <!-- Дизайн: заглушка -->
            <div class="panel panel-muted px-3 py-2 min-w-[220px]">
              <div class="flex items-center justify-between">
                <span class="text-xs">Дизайн</span>
                <select id="design" class="hidden" disabled>
                  <option value="yougile" selected>YouGile</option>
                </select>
              </div>
              <div class="mt-2 flex items-center gap-2 text-sm">
                <i data-lucide="hammer" class="w-4 h-4"></i>
                <span class="font-medium">Stand-by</span>
                <span class="chip text-[11px] px-2 py-0.5 rounded-md">in progress</span>
              </div>
            </div>

            <!-- Сорт -->
            <div class="panel px-3 py-2 min-w-[240px]">
              <div class="flex items-center justify-between">
                <span class="text-xs text-slate-400">Сорт</span>
                <select id="sortBy" class="hidden">
                  <option value="none">Без сортировки</option>
                  <option value="deadline">Дедлайн</option>
                  <option value="priority">Приоритет</option>
                  <option value="plan">План (ч)</option>
                  <option value="fact">Факт (ч)</option>
                </select>
              </div>
              <div id="comboSort" class="os-combo mt-2">
                <button class="os-combo-btn" type="button">
                  <span id="comboSortLabel" class="font-medium">Без сортировки</span>
                  <i data-lucide="chevrons-up-down" class="w-4 h-4 opacity-70"></i>
                </button>
                <div class="os-combo-menu">
                  <button class="os-combo-item" data-value="none">Без сортировки</button>
                  <button class="os-combo-item" data-value="deadline">Дедлайн</button>
                  <button class="os-combo-item" data-value="priority">Приоритет</button>
                  <button class="os-combo-item" data-value="plan">План (ч)</button>
                  <button class="os-combo-item" data-value="fact">Факт (ч)</button>
                </div>
              </div>
            </div>

            <!-- Режим -->
            <div class="panel px-3 py-2 flex-1 min-w-[260px]">
              <div class="text-xs text-slate-400 mb-1">Режим</div>
              <div id="modeSwitch" class="mode-switch">
                <div id="modeThumb" class="mode-thumb"></div>
                <button data-mode="collage" class="mode-item"><i data-lucide="grid-3x3" class="w-4 h-4"></i>Коллаж</button>
                <button data-mode="tower"   class="mode-item inactive"><i data-lucide="panel-right" class="w-4 h-4"></i>Башня</button>
              </div>
            </div>

            <!-- Тема -->
            <div class="panel px-3 py-2 flex items-center justify-between min-w-[160px]">
              <span class="text-xs text-slate-400">Тема</span>
              <button id="themeSwitch" class="theme-switch"><span class="theme-thumb"></span></button>
            </div>
          </div>

          <!-- Экспорт -->
          <div class="flex items-center gap-2">
            <button id="btnExportPNG" disabled class="px-4 py-2 rounded-xl panel disabled:opacity-50">PNG</button>
            <button id="btnCopy"      disabled class="px-4 py-2 rounded-xl bg-white/10 text-white border border-white/10 disabled:opacity-50">Копировать</button>
          </div>

        </div>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="flex-1 w-full">
    <section class="max-w-[1200px] mx-auto px-4 py-10">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        <div class="lg:col-span-8">
          <div id="dropzone" class="panel p-10 md:p-14 text-center bg-gradient-to-b from-slate-900 to-slate-900/40">
            <div id="uploadIcon" class="mx-auto w-20 h-20 rounded-3xl grid place-items-center shadow-soft icon-tile">
              <i data-lucide="upload" class="w-10 h-10"></i>
            </div>
            <h2 class="mt-5 text-2xl md:text-3xl font-extrabold">Перетащи .xlsx сюда</h2>
            <p class="mt-2 text-slate-400">
              или <label for="fileInput" class="text-indigo-300 cursor-pointer underline decoration-dotted">выбери файл</label>.
              «Задачи на сегодня …» → План, «Сделано сегодня …» → Факт.
            </p>
            <input id="fileInput" type="file" accept=".xlsx,.xls" class="hidden"/>

            <div id="progressWrap" class="mx-auto mt-8 max-w-xl text-left hidden">
              <div class="flex items-center justify-between mb-1">
                <span id="progressLabel" class="text-xs text-slate-400">Готово: 0%</span>
                <span id="progressStep"  class="text-xs text-slate-400">—</span>
              </div>
              <div class="h-3 rounded-full bg-slate-800 overflow-hidden">
                <div id="progressBar" class="h-full w-0 bg-indigo-600 transition-all duration-300"></div>
              </div>
              <div id="diag" class="mt-3 text-[12px] text-slate-400"></div>
            </div>
          </div>
        </div>

        <div class="lg:col-span-4">
          <div class="panel p-5">
            <div class="text-sm text-slate-400 mb-2">Сводка</div>
            <div class="grid grid-cols-2 gap-3 text-center">
              <div class="panel py-3"><div class="text-xs text-slate-400">Дата</div><div id="sumDate" class="font-semibold">—</div></div>
              <div class="panel py-3"><div class="text-xs text-slate-400">Задач</div><div id="sumCount" class="font-semibold">0</div></div>
              <div class="panel py-3"><div class="text-xs text-slate-400">План (ч)</div><div id="sumPlan" class="font-semibold">0</div></div>
              <div class="panel py-3"><div class="text-xs text-slate-400">Факт (ч)</div><div id="sumFact" class="font-semibold">0</div></div>
            </div>
            <div id="whyEmpty" class="hidden mt-4 panel p-4 text-sm text-rose-400">
              Ничего не отрисовано. Проверь названия колонок в Excel — ключевые поля не найдены.
            </div>
          </div>
        </div>
      </div>

      <!-- РЕНДЕР -->
      <section id="collageWrap" class="mt-10 hidden">
        <div class="flex items-center justify-between gap-4">
          <h3 id="collageTitle" class="text-3xl font-extrabold tracking-tight"></h3>
          <div id="modeHint" class="text-sm text-slate-400"></div>
        </div>
        <div class="mt-4 panel p-4">
          <div class="overflow-auto">
            <div id="renderRoot" style="width:1123px;">
              <img src="./assets/bg_blur.jpg" alt="" class="bg-img select-none pointer-events-none">
              <div class="bg-overlay"></div>
              <div class="stage-pad">
                <div id="topSummary" class="mb-4 grid grid-cols-12 gap-3">
                  <div class="col-span-5 md:col-span-4 kpi flex items-center justify-start p-6">
                    <div>
                      <div id="summaryTitle" class="text-4xl md:text-5xl font-extrabold leading-[1.05]">Сделано сегодня</div>
                      <div id="factBadge" class="mt-3 inline-flex items-center gap-2 px-3 py-1 rounded-full bg-emerald-600 text-white text-sm hidden">
                        <i data-lucide="check-circle" class="w-4 h-4"></i><span id="factBadgeText"></span>
                      </div>
                    </div>
                  </div>
                  <div class="col-span-7 md:col-span-8 grid grid-cols-4 gap-3">
                    <div class="kpi text-center"><div class="t">Дата</div><div class="v" id="kpiDate">—</div></div>
                    <div class="kpi text-center"><div class="t">Задач</div><div class="v" id="kpiTasks">0</div></div>
                    <div class="kpi text-center"><div class="t">План (ч)</div><div class="v" id="kpiPlan">0</div></div>
                    <div class="kpi text-center"><div class="t">Факт (ч)</div><div class="v" id="kpiFact">0</div></div>
                  </div>
                </div>
                <div id="collage" class="grid gap-4" style="grid-template-columns:repeat(2,minmax(0,1fr));"></div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="mt-10">
    <div class="backdrop-blur bg-slate-900/70 border-t border-slate-800">
      <div class="max-w-[1200px] mx-auto px-4 py-6 flex items-center justify-between">
        <div class="flex items-center gap-2 text-sm text-slate-400">
          <span class="inline-flex items-center gap-2 px-3 py-1 rounded-xl bg-slate-800 border border-slate-700/40">
            <i data-lucide="heart" class="w-4 h-4 text-rose-500"></i> OneScreen
          </span>
          <span class="text-xs">© just vibes</span>
        </div>
        <div class="text-xs text-slate-400">План/Факт by Vatnik</div>
      </div>
    </div>
  </footer>

  <!-- Support FAB -->
  <button id="supportFab" title="Что-то сломалось?"
    class="fixed bottom-6 right-6 z-50 p-3 rounded-full
           bg-white/20 dark:bg-slate-800/60
           backdrop-blur-md border border-white/30 dark:border-white/10
           shadow-lg hover:scale-110 active:scale-95 transition">
    <i data-lucide="life-buoy" class="w-6 h-6 text-slate-900 dark:text-white"></i>
  </button>

  <!-- Support Modal -->
  <div id="supportModal" class="fixed inset-0 z-50 hidden opacity-0 pointer-events-none transition-opacity duration-200">
    <div id="supportBackdrop" class="absolute inset-0 bg-black/40 backdrop-blur-sm opacity-0 transition-opacity duration-200"></div>
    <div class="relative h-full w-full grid place-items-center p-4">
      <div id="supportCard" class="panel w-full max-w-md p-6 transform-gpu opacity-0 scale-95 transition duration-200">
        <div class="flex items-center justify-between">
          <h4 class="text-lg font-semibold">Техподдержка</h4>
          <button id="modalClose" class="rounded-lg px-2 py-1 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:opacity-80 transition">
            <i data-lucide="x" class="w-4 h-4"></i>
          </button>
        </div>
        <p class="mt-3 text-sm text-slate-500 dark:text-slate-400">По вопросам в телегу:</p>
        <a href="https://t.me/Vatnik13" target="_blank"
           class="mt-4 flex items-center gap-2 px-4 py-3 rounded-xl
                  bg-gradient-to-r from-indigo-600 to-indigo-500
                  text-white font-semibold hover:opacity-90 transition">
          <i data-lucide="send" class="w-5 h-5"></i> @Vatnik13
        </a>
      </div>
    </div>
  </div>

<script>
/* ===== Splash ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  const s=document.getElementById('splash');
  if(!s) return;
  setTimeout(()=>{ s.classList.add('splash-hide'); },1500);
  setTimeout(()=>{ if(document.body.contains(s)) s.remove(); },3500);
});

/* ===== Utils ===== */
const $=(s,r=document)=>r.querySelector(s);
const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const toast=(m)=>{const b=$("#toast>div"); b.textContent=m; $("#toast").classList.remove("hidden"); setTimeout(()=>$("#toast").classList.add("hidden"),2200);};
const esc=(s="")=>String(s).replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
const num=(v)=>{ if(typeof v==='number')return v; if(v==null||v==='')return 0; const s=String(v).replace(",",".").replace(/[^\d.-]/g,""); const n=parseFloat(s); return isNaN(n)?0:n; };
const prRank=(p="")=>{ p=String(p).toLowerCase(); if(p.includes('пожар')||p.includes('alarm')||p.includes('аларм'))return 0; if(p.includes('важно'))return 1; return 2; };
const cleanTitle=(t="")=> String(t).replace(/^\s*[A-ZА-Я]{2,}-?\d+\s*[—-]\s*/i,'').trim();
function canon(s){ return String(s||'').replace(/[“”«»„‟"']/g,'"').replace(/ё/g,'е').replace(/\s+/g,' ').trim().toLowerCase(); }
function cell(row,i){ return i>=0 ? (row[i] ?? '') : ''; }
function detectMode(name=""){ const n=String(name).toLowerCase(); if(n.includes('сделано сегодня')) return 'fact'; if(n.includes('задачи на сегодня')) return 'plan'; return 'plan'; }
function extractDate(name=""){
  const m = String(name).match(/(\d{1,2})\.(\d{2})\.(\d{4})/);
  if(!m) return '—';
  return `${m[1]}.${m[2]}.${m[3]}`;
}


/* ===== Theme ===== */
const themeSwitch=$("#themeSwitch");
const applyTheme=()=>{ const t=localStorage.getItem('theme')||'dark'; document.documentElement.classList.toggle('dark',t==='dark'); document.body.classList.toggle('light', t!=='dark'); themeSwitch.classList.toggle('on', t==='dark'); };
applyTheme();
themeSwitch.addEventListener('click',()=>{
  const dark=document.documentElement.classList.toggle('dark');
  document.body.classList.toggle('light', !dark);
  localStorage.setItem('theme', dark?'dark':'light');
  themeSwitch.classList.toggle('on',dark);
});
window.addEventListener('DOMContentLoaded',()=> lucide.createIcons());

/* ===== Refs ===== */
const dropzone=$("#dropzone"), fileInput=$("#fileInput");
const renderRoot=$("#renderRoot"), collage=$("#collage"), collageWrap=$("#collageWrap"),
      collageTitle=$("#collageTitle"), modeHint=$("#modeHint");
const sumDate=$("#sumDate"), sumPlan=$("#sumPlan"), sumFact=$("#sumFact"), sumCount=$("#sumCount"), modeBadge=$("#modeBadge");
const btnPNG=$("#btnExportPNG"), btnCopy=$("#btnCopy");
const colSelect=$("#colSelect"), design=$("#design"), sortBy=$("#sortBy");

/* ===== Mode switch ===== */
const modeSwitch=$("#modeSwitch"), modeThumb=$("#modeThumb"), modeBtns=$$(".mode-item",modeSwitch);
let vizMode='collage';
const setModeUI=(m)=>{ vizMode=m; modeThumb.style.transform=`translateX(${m==='collage'?0:100}%)`; modeBtns.forEach(b=>b.classList.toggle('inactive', b.dataset.mode!==m)); applyLayout(); };
modeBtns.forEach(b=> b.addEventListener('click', ()=> setModeUI(b.dataset.mode)));

/* ===== DnD ===== */
["dragenter","dragover"].forEach(ev=>dropzone.addEventListener(ev,e=>{e.preventDefault();dropzone.classList.add("drop-hover");}));
["dragleave","drop"].forEach(ev=>dropzone.addEventListener(ev,e=>{e.preventDefault();dropzone.classList.remove("drop-hover");}));
dropzone.addEventListener("drop",e=>{ const f=e.dataTransfer.files?.[0]; if(f) handleFile(f); });
dropzone.addEventListener("click",()=>fileInput.click());
fileInput.addEventListener("change",e=>{ const f=e.target.files?.[0]; if(f) handleFile(f); });

/* ===== State ===== */
let tasksRaw=[], tasksView=[], isFact=false, isFactGlobal=false, designStyle='yougile';

/* ===== Progress ===== */
const progressWrap=$("#progressWrap"), progressBar=$("#progressBar"), progressLabel=$("#progressLabel"), progressStep=$("#progressStep"), diag=$("#diag");
function showProgress(){ progressWrap.classList.remove('hidden'); setProgress(0,'Старт'); }
function setProgress(p,step){ progressBar.style.width=p+'%'; progressLabel.textContent=`Готово: ${Math.round(p)}%`; if(step) progressStep.textContent=step; }
function hideProgress(){ setTimeout(()=>progressWrap.classList.add('hidden'),350); }
const setDiag=(html)=>{ diag.innerHTML=html; };

/* ===== Hybrid header dictionary ===== */
const NEED_MAP = {
  id:               ['id задачи','id','код','task id'],
  title:            ['название задачи','название','тема','subject','title'],
  deadline:         ['дедлайн','срок','deadline'],
  board:            ['доска','board'],
  column:           ['колонка','статус','column'],
  project:          ['проект','project'],
  last_msg:         ['дата последнего сообщения','последнее сообщение','last message'],
  msgs:             ['кол-во сообщений','сообщений','messages'],
  sticker_priority: ['стикер "приоритет"','приоритет','priority'],
  sticker_stage:    ['стикер "этап"','этап','stage'],
  sticker_project:  ['стикер "проект"','проект (стикер)','project sticker'],
  sticker_plan:     ['стикер "план сегодня"','план сегодня','план','plan'],
  sticker_fact:     ['стикер "факт часов"','факт часов','факт','fact'],
  sticker_category: ['стикер "категория"','категория','category'],
};

/* ===== Helpers for hybrid detection ===== */
function findHeaderRow(matrix){
  // ищем строку, где совпадёт максимум по словарю (>=5 сигналов — надёжный хедер)
  let best = {idx:-1, score:0, map:[]};
  for(let r=0; r<Math.min(matrix.length, 50); r++){
    const row = matrix[r] || [];
    const norm = row.map(canon);
    let score = 0;
    for(const keys of Object.values(NEED_MAP)){
      const probes = keys.map(canon);
      const hit = norm.find(h => probes.some(p => h.includes(p)));
      if(hit) score++;
    }
    if(score > best.score){ best = {idx:r, score, map:norm}; }
  }
  return (best.score>=3) ? best : {idx:0, score:0, map: (matrix[0]||[]).map(canon)};
}

function indexColumns(normHeader){
  const findCol=(vars)=>{
    const vs=vars.map(canon);
    // точное совпадение
    for(const v of vs){ const i=normHeader.indexOf(v); if(i>=0) return i; }
    // contains
    for(const v of vs){ const i=normHeader.findIndex(h=>h.includes(v)); if(i>=0) return i; }
    // все слова содержатся
    for(const v of vs){
      const w=v.split(' ').filter(Boolean);
      const i=normHeader.findIndex(h=>w.every(x=>h.includes(x)));
      if(i>=0) return i;
    }
    return -1;
  };
  const idx={};
  Object.entries(NEED_MAP).forEach(([k,vars]) => idx[k]=findCol(vars));
  return idx;
}

function rowEmpty(row){
  if(!row) return true;
  return row.every(v => String(v ?? '').trim() === '');
}
function isSummaryRow(row){
  const s = canon((row && row[0]) || '');
  return /^сумма значений/.test(s);
}

async function handleFile(file){
  try{
    showProgress(); setProgress(10,'Читаю файл');
    const mode = detectMode(file.name); isFact = mode==='fact'; isFactGlobal=isFact;
    modeBadge.textContent = isFact ? 'режим: ФАКТ' : 'режим: ПЛАН';

    const buf = await file.arrayBuffer();
    setProgress(25,'Парсю книгу');
    const wb = XLSX.read(buf,{type:'array'});

    let allTasks = [];
    let diagParts = [];

    // обойдём все листы (их может быть несколько)
    wb.SheetNames.forEach(sheetName=>{
      const sheet = wb.Sheets[sheetName];
      if(!sheet) return;

      // читаем ВСЁ как матрицу, дефолт — пустая строка
      const M = XLSX.utils.sheet_to_json(sheet,{header:1,defval:"",raw:true, blankrows:false});
      if(!M || !M.length) return;

      // 1-я строка — заголовки
      const headersRaw = M[0] || [];
      const headers = headersRaw.map(h => canon(h));
      const rows = M.slice(1);

      // индексатор колонок
      const NEED_MAP = {
        id:               ['id задачи','id','код','task id'],
        title:            ['название задачи','название','тема','subject','title'],
        deadline:         ['дедлайн','срок','deadline'],
        board:            ['доска','board'],
        column:           ['колонка','статус','column'],
        project:          ['проект','project'],
        last_msg:         ['дата последнего сообщения','последнее сообщение','last message'],
        msgs:             ['кол-во сообщений','сообщений','messages'],
        sticker_priority: ['стикер "приоритет"','приоритет','priority'],
        sticker_stage:    ['стикер "этап"','этап','stage'],
        sticker_project:  ['стикер "проект"','проект (стикер)','project sticker'],
        sticker_plan:     ['стикер "план сегодня"','план сегодня','план','plan'],
        sticker_fact:     ['стикер "факт часов"','факт часов','факт','fact'],
        sticker_category: ['стикер "категория"','категория','category'],
      };
      const findCol=(vars)=>{
        const vs = vars.map(canon);
        // точное
        for(const v of vs){ const i=headers.indexOf(v); if(i>=0) return i; }
        // contains
        for(const v of vs){ const i=headers.findIndex(h=>h.includes(v)); if(i>=0) return i; }
        // все слова содержатся
        for(const v of vs){
          const w=v.split(' ').filter(Boolean);
          const i=headers.findIndex(h=>w.every(x=>h.includes(x)));
          if(i>=0) return i;
        }
        return -1;
      };
      const idx={}; Object.entries(NEED_MAP).forEach(([k,v])=> idx[k]=findCol(v));

      // диагностика
      const found = Object.entries(idx).filter(([_,i])=>i>=0).map(([k,i])=>`${k} → <b>${XLSX.utils.encode_col(i)} (${headersRaw[i]||'?'})</b>`).join('<br>');
      const miss  = Object.entries(idx).filter(([_,i])=>i<0).map(([k])=>k).join(', ') || '—';
      diagParts.push(`<b>${esc(sheetName)}</b>: строк: <b>${M.length}</b><br><u>Найдены:</u><br>${found||'—'}<br><u>Отсутствуют:</u> ${miss}`);

      // если нет и ID, и Title — бессмысленно
      if(idx.title<0 && idx.id<0) return;

      // идём по строкам до «Сумма значений», пропуская полностью пустые
      for(const row of rows){
        if(isSummaryRow(row)) break;
        if(rowEmpty(row)) continue;

        const t = {
          id:               cell(row, idx.id),
          title:            cell(row, idx.title),
          deadline:         cell(row, idx.deadline),
          board:            cell(row, idx.board),
          column:           cell(row, idx.column),
          project:          cell(row, idx.project),
          last_msg:         cell(row, idx.last_msg),
          msgs:             cell(row, idx.msgs),
          sticker_priority: cell(row, idx.sticker_priority),
          sticker_stage:    cell(row, idx.sticker_stage),
          sticker_project:  cell(row, idx.sticker_project),
          sticker_plan:     cell(row, idx.sticker_plan),
          sticker_fact:     cell(row, idx.sticker_fact),
          sticker_category: cell(row, idx.sticker_category),
        };

        // ключевой критерий: есть ID или Название
        if(String(t.id||t.title||'').trim()==='') continue;

        allTasks.push(t);
      }
    });

    setDiag(diagParts.join('<hr>'));

    if(!allTasks.length){
      $("#whyEmpty").classList.remove('hidden');
      toast('Задачи не найдены'); hideProgress(); return;
    }

    setProgress(78,'Рисую карточки');
    tasksRaw = allTasks;
    render(tasksRaw,isFact,file.name);

    setProgress(100,'Готово ✔'); hideProgress(); enableExports(true);
    $("#collageWrap").scrollIntoView({behavior:'smooth',block:'start'});
  }catch(e){ console.error(e); toast('Ошибка обработки файла'); hideProgress(); }
}


/* ===== Render ===== */
function render(list,isFact,filename){
  isFactGlobal=isFact;
  const when = extractDate(filename);
  sumDate.textContent=when; $("#kpiDate").textContent=when;

  const titleText = isFact ? 'Сделано сегодня' : 'Задачи на сегодня';
  $("#summaryTitle").textContent=titleText; collageTitle.textContent=titleText;
  modeHint.textContent = vizMode==='tower' ? 'Режим «Башня»: одна колонка' : 'Режим «Коллаж»: сетка карточек';

  tasksView=sortList(list,sortBy.value);

  const sp=tasksView.reduce((a,t)=>a+num(t.sticker_plan),0);
  const sf=tasksView.reduce((a,t)=>a+num(t.sticker_fact),0);
  sumPlan.textContent=String(sp).replace('.',',');
  sumFact.textContent=String(sf).replace('.',',');
  sumCount.textContent=tasksView.length;
  $("#kpiPlan").textContent=String(sp).replace('.',',');
  $("#kpiFact").textContent=String(sf).replace('.',',');
  $("#kpiTasks").textContent=tasksView.length;

  const factBadge=$("#factBadge"), factBadgeText=$("#factBadgeText");
  if(isFact){ factBadge.classList.remove('hidden'); factBadgeText.textContent=`ФАКТ на ${String(sf).replace('.',',')} ч`; } else { factBadge.classList.add('hidden'); }

  applyLayout(); drawCards(tasksView,isFact);
  collageWrap.classList.remove('hidden');
  renderRoot.classList.toggle('tower', vizMode==='tower');

  inlineStageBg();
}

function sortList(a,how){
  const arr=[...a];
  switch(how){
    case 'priority': arr.sort((x,y)=> prRank(x.sticker_priority)-prRank(y.sticker_priority)); break;
    case 'deadline': arr.sort((x,y)=> String(x.deadline||'').localeCompare(String(y.deadline||''))); break;
    case 'plan':     arr.sort((x,y)=> num(y.sticker_plan)-num(x.sticker_plan)); break;
    case 'fact':     arr.sort((x,y)=> num(y.sticker_fact)-num(x.sticker_fact)); break;
  }
  return arr;
}

function applyLayout(){
  if(vizMode==='tower'){
    $("#collage").style.gridTemplateColumns='repeat(1,minmax(0,1fr))';
    renderRoot.style.width='860px';
    colSelect.disabled=true;
  }else{
    colSelect.disabled=false;
    const n=parseInt(colSelect.value||'2',10);
    $("#collage").style.gridTemplateColumns=`repeat(${n},minmax(0,1fr))`;
    const widthPerCol=540;
    renderRoot.style.width=`${Math.max(700, n*widthPerCol + (n-1)*16) + 48}px`;
  }
}
colSelect.addEventListener('change', ()=> vizMode==='collage' && applyLayout());
design.addEventListener('change', ()=>{ designStyle=design.value; drawCards(tasksView,isFactGlobal); });
sortBy.addEventListener('change', ()=>{ tasksView=sortList(tasksView, sortBy.value); drawCards(tasksView,isFactGlobal); });

/* Chips / badges */
function badge(txt, cls='badge-slate', icon=null){
  if(!txt) return '';
  const ico = icon ? `<i data-lucide="${icon}" class="w-3.5 h-3.5"></i>` : '';
  return `<span class="yg-badge ${cls}">${ico}${esc(txt)}</span>`;
}
function chip(icon, text){ if(!text) return ''; return `<span class="yg-chip"><i data-lucide="${icon}" class="w-3.5 h-3.5"></i>${esc(text)}</span>`; }
function priorityBadge(text){
  if(!text) return '';
  const t=String(text).toLowerCase();
  if(t.includes('пожар')||t.includes('alarm')||t.includes('аларм')) return badge('Аларм сейчас ПОЖАР','badge-red','flame');
  if(t.includes('важно')) return badge('Важно сегодня','badge-amber','flame');
  return badge(text,'badge-slate','flame');
}

function drawCards(items,isFact){
  collage.innerHTML='';
  const pad='p-4 md:p-5';
  const frag=document.createDocumentFragment();

  for(const t of items){
    const fact=num(t.sticker_fact), plan=num(t.sticker_plan);
    const ratio=plan>0? Math.min(100, Math.round(fact/plan*100)) : (fact>0?100:0);
    const titleStr=cleanTitle(String(t.title||'Без названия'));
    const el=document.createElement('article');
    el.className=`card ${pad}`;

    const lead = isFact ? `<i data-lucide="check-circle" class="w-5 h-5 text-emerald-400"></i>` : `<i data-lucide="circle" class="w-5 h-5 text-slate-500"></i>`;

    const projectName = t.sticker_project || t.project || t.board || '';
    const chipsTop = [
      chip('calendar', t.deadline || ''),
      priorityBadge(t.sticker_priority),
      chip('activity', t.sticker_stage || ''),
      chip('boxes', projectName)
    ].filter(Boolean).join(' ');

    const chipsBottom = [
      chip('tag', t.sticker_category || ''),
      chip('target', t.sticker_plan ? `План сегодня: ${num(t.sticker_plan)}` : ''),
      chip('clock',  t.sticker_fact ? `Факт часов: ${num(t.sticker_fact)}` : '')
    ].filter(Boolean).join(' ');

    el.innerHTML = `
      <div class="flex items-start gap-2">
        <div class="mt-1">${lead}</div>
        <div class="flex-1">
          <h4 class="title text-lg md:text-xl">${esc(titleStr)}</h4>
          <div class="mt-3 flex flex-wrap gap-2">${chipsTop}</div>
          <div class="mt-2 flex flex-wrap gap-2">${chipsBottom}</div>
          <div class="mt-3">
            <div class="h-2 rounded-full bg-slate-800 overflow-hidden"><div class="h-full" style="background:#6366f1;width:${ratio}%"></div></div>
            <div class="mt-2 text-xs flex items-center justify-between text-slate-400">
              <div class="inline-flex items-center gap-1"><i data-lucide="message-circle" class="w-3.5 h-3.5"></i> Сообщений: ${esc(t.msgs||'0')}</div>
              <div class="flex items-center gap-4">
                ${t.sticker_plan? `<span class="inline-flex items-center gap-1"><i data-lucide="target" class="w-3.5 h-3.5"></i>${esc(num(t.sticker_plan))}</span>`:''}
                ${t.sticker_fact? `<span class="inline-flex items-center gap-1"><i data-lucide="clock" class="w-3.5 h-3.5"></i>${esc(num(t.sticker_fact))}</span>`:''}
              </div>
            </div>
          </div>
        </div>
      </div>`;
    frag.appendChild(el);
  }
  collage.appendChild(frag);
  lucide.createIcons();
}

/* ===== Export ===== */
function enableExports(v){ btnPNG.disabled=btnCopy.disabled=!v; }

// инлайн фона в dataURL
async function inlineStageBg(){
  const img = renderRoot.querySelector('.bg-img');
  if(!img || img.dataset.inlined) return;
  try{
    const r = await fetch(img.getAttribute('src'), {cache:'force-cache'});
    const b = await r.blob();
    const fr = new FileReader();
    await new Promise(res=>{ fr.onload=()=>res(); fr.readAsDataURL(b); });
    img.src = fr.result;
    img.dataset.inlined = '1';
  }catch(e){ console.warn('BG inline fail', e); }
}

async function stabilize(){
  await document.fonts.ready;
  lucide.createIcons();
  await inlineStageBg();
  await new Promise(r=>requestAnimationFrame(()=>requestAnimationFrame(r)));
}

async function exportAsBlob(){
  await stabilize();
  try{
    const blob = await htmlToImage.toBlob(renderRoot, { cacheBust:true, pixelRatio:2, backgroundColor:null, style:{} });
    if(blob) return blob;
  }catch(e){ console.warn('html-to-image failed, fallback to html2canvas', e); }
  const canvas = await html2canvas(renderRoot,{ backgroundColor:null, scale:2, useCORS:false, allowTaint:true, foreignObjectRendering:true, imageTimeout:0, removeContainer:true, logging:false });
  return await new Promise(res=>canvas.toBlob(res));
}

btnPNG.addEventListener('click', async ()=>{
  try{
    const blob = await exportAsBlob();
    if(!blob) throw new Error('No blob');
    const link=document.createElement('a');
    link.href=URL.createObjectURL(blob);
    link.download=`${collageTitle.textContent}.png`;
    link.click();
    URL.revokeObjectURL(link.href);
  }catch(e){ console.error(e); toast('Ошибка при экспорте PNG'); }
});

btnCopy.addEventListener('click', async ()=>{
  try{
    const blob = await exportAsBlob();
    if(!blob) throw new Error('No blob');
    try{
      await navigator.clipboard.write([new ClipboardItem({'image/png':blob})]);
      toast('Скопировано в буфер ✔');
    }catch(_){ toast('Буфер недоступен — скачай PNG'); }
  }catch(e){ console.error(e); toast('Ошибка при копировании'); }
});

/* ===== Support FAB + Modal (animated) ===== */
const supportFab      = document.getElementById("supportFab");
const supportModal    = document.getElementById("supportModal");
const supportBackdrop = document.getElementById("supportBackdrop");
const supportCard     = document.getElementById("supportCard");
const modalClose      = document.getElementById("modalClose");

function openSupport() {
  supportModal.classList.remove("hidden","pointer-events-none");
  requestAnimationFrame(() => {
    supportModal.classList.remove("opacity-0");
    supportBackdrop.classList.remove("opacity-0");
    supportCard.classList.remove("opacity-0","scale-95");
    supportCard.classList.add("opacity-100","scale-100");
  });
  if (window.lucide) lucide.createIcons();
}
function closeSupport() {
  supportModal.classList.add("opacity-0");
  supportBackdrop.classList.add("opacity-0");
  supportCard.classList.remove("opacity-100","scale-100");
  supportCard.classList.add("opacity-0","scale-95");
  setTimeout(() => { supportModal.classList.add("hidden","pointer-events-none"); }, 180);
}
supportFab.addEventListener("click", openSupport);
modalClose.addEventListener("click", closeSupport);
supportModal.addEventListener("click", (e) => { if (!supportCard.contains(e.target)) closeSupport(); });
document.addEventListener("keydown", (e) => { if (e.key === "Escape" && !supportModal.classList.contains("hidden")) closeSupport(); });

/* ===== Hidden selects dispatcher ===== */
function setSelectValue(sel, value) {
  if (!sel) return;
  sel.value = value;
  sel.dispatchEvent(new Event('change', { bubbles: true }));
}

/* === Segments: Колонки (точное позиционирование thumb) === */
/* Единственный рабочий блок — дубли удалены */
(() => {
  const seg    = document.getElementById('segCols');
  if (!seg) return;
  const thumb  = seg.querySelector('.thumb');
  const btns   = [...seg.querySelectorAll('button[data-value]')];
  const select = document.getElementById('colSelect');

  let currentIdx = Math.max(0, btns.findIndex(b => b.dataset.value === (select?.value || '2')));

  function placeThumb(idx){
    const b = btns[idx];
    if(!b) return;
    const rBtn = b.getBoundingClientRect();
    const rSeg = seg.getBoundingClientRect();
    const x = rBtn.left - rSeg.left;
    const w = rBtn.width;

    thumb.style.transform = `translateX(${x}px)`;
    thumb.style.width = `${w}px`;

    btns.forEach((el,i)=> el.toggleAttribute('data-active', i===idx));
    currentIdx = idx;
  }

  function setActive(val){
    const idx = Math.max(0, btns.findIndex(b => b.dataset.value === String(val)));
    if (select && select.value !== String(val)) {
      select.value = String(val);
      select.dispatchEvent(new Event('change', {bubbles:true}));
    }
    placeThumb(idx);
  }

  btns.forEach((b) => b.addEventListener('click', () => setActive(b.dataset.value)));
  placeThumb(currentIdx);
  window.addEventListener('resize', () => placeThumb(currentIdx));
})();

/* === Combobox: Сорт === */
(() => {
  const wrap = document.getElementById('comboSort');
  const btn  = wrap.querySelector('.os-combo-btn');
  const lab  = document.getElementById('comboSortLabel');
  const menu = wrap.querySelector('.os-combo-menu');
  const items= [...wrap.querySelectorAll('.os-combo-item')];
  const select = document.getElementById('sortBy');

  const apply = (val, label) => {
    lab.textContent = label;
    wrap.classList.remove('open');
    if (select && select.value !== val) {
      select.value = val;
      select.dispatchEvent(new Event('change', {bubbles:true}));
    }
  };

  btn.addEventListener('click', () => wrap.classList.toggle('open'));
  items.forEach(i => i.addEventListener('click', () => apply(i.dataset.value, i.textContent.trim())));
  document.addEventListener('click', (e)=>{ if(!wrap.contains(e.target)) wrap.classList.remove('open'); });

  const cur = select?.options[select.selectedIndex]?.textContent?.trim() || 'Без сортировки';
  lab.textContent = cur;
})();
</script>
</body>
</html>

