<!DOCTYPE html>
<html lang="ru" class="scroll-smooth">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>OneScreen План/Факт — by Vatnik</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'] },
          boxShadow: { soft: '0 10px 30px rgba(0,0,0,.08)' },
          colors: { os:{ primary:'#4f46e5', accent:'#22c55e', warn:'#ef4444' } }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{ --ring:#e2e8f0 }
    *{ scrollbar-width:thin; scrollbar-color:#CBD5E1 transparent }
    *::-webkit-scrollbar{ width:8px;height:8px } *::-webkit-scrollbar-thumb{ background:#CBD5E1;border-radius:9999px }
    .panel{ border:1px solid var(--ring); border-radius:16px; background:#fff; box-shadow:0 10px 30px rgba(0,0,0,.06) }
    .dark .panel{ background:#0b1220; border-color:#1f2937 }
    .kanban-card{ border:1px solid var(--ring); border-radius:16px; background:#fff; box-shadow:0 10px 30px rgba(0,0,0,.06) }
    .dark .kanban-card{ background:#0b1220; border-color:#1f2937 }
    .pill{ border-radius:999px; padding:2px 8px; font-size:12px; line-height:18px }
    .chip{ border-radius:10px; padding:2px 8px; font-size:12px; line-height:18px; background:#F8FAFC; border:1px solid #E2E8F0 }
    .dark .chip{ background:#111827; border-color:#1f2937; color:#cbd5e1 }
    .fade-dim{ filter:saturate(.75) brightness(.92) }
    .drop-hover{ outline:3px dashed #4f46e5; outline-offset:-10px }
    @media print{ @page{ size:A4 portrait; margin:10mm } }
  </style>
</head>
<body class="min-h-screen flex flex-col font-sans bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100 selection:bg-indigo-200 selection:text-indigo-900">

  <!-- SPLASH -->
  <div id="splash" class="fixed inset-0 z-50 grid place-items-center bg-[#0b1020]">
    <div class="relative w-full h-full overflow-hidden">
      <img src="./assets/bg.jpg" alt="" class="absolute inset-0 w-full h-full object-cover opacity-60"/>
      <div class="absolute inset-0 bg-gradient-to-b from-indigo-900/20 via-slate-900/30 to-slate-900/70"></div>
      <div class="relative h-full w-full flex items-center justify-center">
        <div id="splashContent" class="text-center">
          <div class="inline-flex items-center gap-3 px-5 py-2 rounded-2xl bg-white/10 backdrop-blur ring-1 ring-white/20">
            <span class="text-white/90 font-semibold tracking-wide">OneScreen</span>
          </div>
          <h1 class="mt-5 text-3xl md:text-5xl font-extrabold text-white drop-shadow">План/Факт <span class="text-indigo-200">by Vatnik</span></h1>
          <p class="mt-3 text-white/80">Перетащи xlsx — получи красивый коллаж задач.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- HEADER / FULL-WIDTH TOOLBAR -->
  <header class="sticky top-0 z-40">
    <div class="backdrop-blur bg-white/70 dark:bg-slate-900/70 border-b border-slate-200 dark:border-slate-800">
      <div class="max-w-7xl mx-auto px-4">
        <div class="py-4 md:py-5 grid grid-cols-1 md:grid-cols-12 gap-3">
          <div class="md:col-span-3 flex items-center gap-3">
            <div class="w-10 h-10 rounded-2xl bg-indigo-600 grid place-items-center text-white font-bold">OS</div>
            <div class="leading-tight">
              <div class="font-semibold text-lg">OneScreen: План/Факт</div>
              <div id="modeBadge" class="text-xs text-slate-500 dark:text-slate-400">режим не выбран</div>
            </div>
          </div>

          <div class="md:col-span-6 grid grid-cols-2 sm:grid-cols-4 gap-2">
            <div class="panel px-3 py-2 flex items-center justify-between">
              <span class="text-xs text-slate-500 dark:text-slate-400">Колонки</span>
              <select id="colSelect" class="px-2 py-1 text-sm rounded-lg bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700">
                <option value="2">2</option><option value="3">3</option><option value="4">4</option>
              </select>
            </div>
            <div class="panel px-3 py-2 flex items-center justify-between">
              <span class="text-xs text-slate-500 dark:text-slate-400">Плотность</span>
              <select id="density" class="px-2 py-1 text-sm rounded-lg bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700">
                <option value="md">Стандарт</option><option value="sm">Компактно</option>
              </select>
            </div>
            <div class="panel px-3 py-2 flex items-center justify-between col-span-2 sm:col-span-1">
              <span class="text-xs text-slate-500 dark:text-slate-400">Сорт</span>
              <select id="sortBy" class="px-2 py-1 text-sm rounded-lg bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700">
                <option value="none">Без сортировки</option>
                <option value="priority">Приоритет</option>
                <option value="deadline">Дедлайн</option>
                <option value="plan">План (ч)</option>
                <option value="fact">Факт (ч)</option>
              </select>
            </div>
            <div class="panel px-3 py-2 flex items-center justify-between">
              <span class="text-xs text-slate-500 dark:text-slate-400">Тема</span>
              <button id="themeToggle" class="px-2 py-1 text-sm rounded-lg bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700">
                <i data-lucide="sun" class="w-4 h-4 hidden dark:inline"></i><i data-lucide="moon" class="w-4 h-4 dark:hidden"></i>
              </button>
            </div>
          </div>

          <div class="md:col-span-3 flex items-center gap-2 justify-end">
            <button id="btnExportPNG" disabled class="px-4 py-2 rounded-xl panel disabled:opacity-50">PNG</button>
            <button id="btnExportPDF" disabled class="px-4 py-2 rounded-xl panel disabled:opacity-50">PDF</button>
            <button id="btnCopy" disabled class="px-4 py-2 rounded-xl bg-slate-900 text-white dark:bg-white dark:text-slate-900 disabled:opacity-50">Копировать</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="flex-1 w-full">
    <section class="max-w-7xl mx-auto px-4 py-10">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        <div class="lg:col-span-8">
          <!-- Dropzone -->
          <div id="dropzone" class="panel p-10 md:p-14 text-center bg-gradient-to-b from-white to-slate-50 dark:from-slate-900 dark:to-slate-900/40">
            <div class="mx-auto w-20 h-20 rounded-3xl bg-indigo-50 dark:bg-indigo-900/40 grid place-items-center text-indigo-600 dark:text-indigo-300 shadow-soft">
              <i data-lucide="upload" class="w-10 h-10"></i>
            </div>
            <h2 class="mt-5 text-2xl md:text-3xl font-extrabold">Перетащи .xlsx сюда</h2>
            <p class="mt-2 text-slate-500 dark:text-slate-400">или <label for="fileInput" class="text-indigo-700 dark:text-indigo-300 cursor-pointer underline decoration-dotted">выбери файл</label>. «Задачи на сегодня …» → План, «Сделано сегодня …» → Факт.</p>
            <input id="fileInput" type="file" accept=".xlsx,.xls" class="hidden"/>
            <!-- Progress -->
            <div id="progressWrap" class="mx-auto mt-8 max-w-xl text-left hidden">
              <div class="flex items-center justify-between mb-1">
                <span id="progressLabel" class="text-xs text-slate-500 dark:text-slate-400">Готово: 0%</span>
                <span id="progressStep" class="text-xs text-slate-500 dark:text-slate-400">—</span>
              </div>
              <div class="h-3 rounded-full bg-slate-200 dark:bg-slate-800 overflow-hidden">
                <div id="progressBar" class="h-full w-0 bg-indigo-600 transition-all duration-300"></div>
              </div>
              <div id="diag" class="mt-3 text-[12px] text-slate-500 dark:text-slate-400"></div>
            </div>
            <div id="dropHint" class="mt-6 text-sm text-slate-500 dark:text-slate-400">После генерации появится коллаж и кнопки скачивания.</div>
          </div>
        </div>

        <div class="lg:col-span-4 space-y-4">
          <div class="panel p-5">
            <div class="text-sm text-slate-500 dark:text-slate-400 mb-2">Сводка</div>
            <div class="grid grid-cols-2 gap-3 text-center">
              <div class="panel py-3"><div class="text-xs text-slate-500 dark:text-slate-400">Дата</div><div id="sumDate" class="font-semibold">—</div></div>
              <div class="panel py-3"><div class="text-xs text-slate-500 dark:text-slate-400">Задач</div><div id="sumCount" class="font-semibold">0</div></div>
              <div class="panel py-3"><div class="text-xs text-slate-500 dark:text-slate-400">План (ч)</div><div id="sumPlan" class="font-semibold">0</div></div>
              <div class="panel py-3"><div class="text-xs text-slate-500 dark:text-slate-400">Факт (ч)</div><div id="sumFact" class="font-semibold">0</div></div>
            </div>
            <div class="mt-4">
              <input id="quickSearch" type="text" placeholder="Найти по названию/ID…" class="w-full px-3 py-2 rounded-lg bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-sm"/>
            </div>
          </div>

          <div id="whyEmpty" class="hidden panel p-4 text-sm text-rose-600 dark:text-rose-400">
            Ничего не отрисовано. Проверь заголовки колонок в Excel — нужные ключи не найдены. Скопируй их названия из подсказки под прогрессом и пришли — добавлю в словарь.
          </div>
        </div>
      </div>

      <!-- Collage -->
      <section id="collageWrap" class="mt-10 hidden">
        <h3 id="collageTitle" class="text-3xl font-extrabold tracking-tight"></h3>
        <div class="mt-4 panel p-4">
          <div class="overflow-auto">
            <div id="collage" class="grid gap-4" style="width:1123px; grid-template-columns:repeat(2,minmax(0,1fr));"></div>
          </div>
        </div>
      </section>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="mt-10 border-t border-slate-200 dark:border-slate-800">
    <div class="max-w-7xl mx-auto px-4 py-6 flex items-center justify-between">
      <div class="flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400">
        <span class="inline-flex items-center gap-2 px-3 py-1 rounded-xl bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700">
          <i data-lucide="heart" class="w-4 h-4 text-rose-500"></i>
          OneScreen
        </span>
        <span class="text-xs">© just vibes</span>
      </div>
      <div class="text-xs text-slate-500 dark:text-slate-400">План/Факт by Vatnik</div>
    </div>
  </footer>

  <!-- Support FAB -->
  <button id="supportFab" title="Техподдержка" class="fixed bottom-6 right-6 z-40 rounded-full shadow-lg bg-indigo-600 hover:bg-indigo-500 text-white w-14 h-14 grid place-items-center">
    <i data-lucide="life-buoy" class="w-6 h-6"></i>
  </button>
  <div id="supportModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 backdrop-blur-sm bg-black/40"></div>
    <div class="relative h-full w-full grid place-items-center p-4">
      <div class="panel w-full max-w-md p-6">
        <div class="flex items-center justify-between">
          <h4 class="text-lg font-semibold">Техподдержка</h4>
          <button id="modalClose" class="rounded-lg px-2 py-1 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700">
            <i data-lucide="x" class="w-4 h-4"></i>
          </button>
        </div>
        <p class="mt-3 text-sm text-slate-500 dark:text-slate-400">Пиши в телеграм:</p>
        <a href="http://t.me/Vatnik13" target="_blank" class="mt-4 flex items-center gap-2 px-4 py-3 rounded-xl bg-gradient-to-r from-indigo-600 to-indigo-500 text-white font-semibold">
          <i data-lucide="send" class="w-5 h-5"></i> @Vatnik13
        </a>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-40 hidden">
    <div class="px-4 py-2 rounded-xl bg-slate-900 text-white shadow-lg text-sm"></div>
  </div>

<script>
  const $=(s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
  const toast=(m)=>{const b=$("#toast>div"); b.textContent=m; $("#toast").classList.remove("hidden"); setTimeout(()=>$("#toast").classList.add("hidden"),2400);};
  const esc=(s="")=>s.replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
  const num=(v)=>{if(typeof v==='number')return v; if(!v)return 0; const s=(""+v).replace(",",".").replace(/[^\d.-]/g,""); const n=parseFloat(s); return isNaN(n)?0:n;};
  const priorityRank=(p="")=>{p=p.toLowerCase(); if(p.includes('пожар')||p.includes('alarm')||p.includes('аларм'))return 0; if(p.includes('важно'))return 1; return 2;};

  // Theme
  const applyStoredTheme=()=>{const t=localStorage.getItem('theme')||'dark'; document.documentElement.classList.toggle('dark', t==='dark');};
  applyStoredTheme();
  $("#themeToggle").addEventListener('click',()=>{const d=document.documentElement.classList.toggle('dark'); localStorage.setItem('theme', d?'dark':'light');});

  // Splash + icons
  (function(){const tl=gsap.timeline(); tl.fromTo("#splashContent",{y:20,opacity:0},{y:0,opacity:1,duration:1,ease:"power3.out"}).to("#splash",{opacity:0,pointerEvents:"none",duration:.7,delay:1.1,ease:"power2.inOut"});})();
  window.addEventListener('DOMContentLoaded',()=>{ lucide.createIcons(); });

  // DOM
  const modeBadge=$("#modeBadge"), dropzone=$("#dropzone"), fileInput=$("#fileInput"), collage=$("#collage"), collageWrap=$("#collageWrap"), collageTitle=$("#collageTitle");
  const quickSearch=$("#quickSearch"), whyEmpty=$("#whyEmpty");
  const sumDate=$("#sumDate"), sumPlan=$("#sumPlan"), sumFact=$("#sumFact"), sumCount=$("#sumCount");
  const btnPNG=$("#btnExportPNG"), btnPDF=$("#btnExportPDF"), btnCopy=$("#btnCopy"), colSelect=$("#colSelect"), density=$("#density"), sortBy=$("#sortBy");
  const progressWrap=$("#progressWrap"), progressBar=$("#progressBar"), progressLabel=$("#progressLabel"), progressStep=$("#progressStep"), diag=$("#diag");
  const supportFab=$("#supportFab"), supportModal=$("#supportModal"), modalClose=$("#modalClose");
  supportFab.addEventListener('click', ()=>{ supportModal.classList.remove('hidden'); gsap.fromTo("#supportModal .panel",{y:20,opacity:0},{y:0,opacity:1,duration:.35,ease:"power2.out"}); });
  modalClose.addEventListener('click', ()=> supportModal.classList.add('hidden'));
  supportModal.addEventListener('click', (e)=>{ if(e.target===supportModal) supportModal.classList.add('hidden'); });

  // DnD
  ["dragenter","dragover"].forEach(ev=>dropzone.addEventListener(ev,e=>{e.preventDefault();dropzone.classList.add("drop-hover");}));
  ["dragleave","drop"].forEach(ev=>dropzone.addEventListener(ev,e=>{e.preventDefault();dropzone.classList.remove("drop-hover");}));
  dropzone.addEventListener("drop",e=>{ const f=e.dataTransfer.files?.[0]; if(f) handleFile(f); });
  dropzone.addEventListener("click",()=>fileInput.click());
  fileInput.addEventListener("change",e=>{ const f=e.target.files?.[0]; if(f) handleFile(f); });

  // State
  let rawTasks=[], viewTasks=[], isFact=false;

  // Progress
  function showProgress(){ progressWrap.classList.remove('hidden'); setProgress(0,'Старт'); }
  function setProgress(p, step){ progressBar.style.width = p+'%'; progressLabel.textContent = `Готово: ${Math.round(p)}%`; if(step) progressStep.textContent = step; }
  function hideProgress(){ setTimeout(()=>progressWrap.classList.add('hidden'), 350); }
  function setDiag(text){ diag.innerHTML = text; }

  // File flow
  async function handleFile(file){
    try{
      quickSearch.value = ''; // чтобы фильтр не обнулял выдачу
      showProgress();
      setProgress(10,'Читаю файл');

      const mode = detectMode(file.name); isFact = mode==='fact'; modeBadge.textContent = isFact ? 'режим: ФАКТ' : 'режим: ПЛАН';
      const buf = await file.arrayBuffer();

      setProgress(25,'Парсю книгу');
      const wb = XLSX.read(buf, {type:'array'});
      // выберем самый плотный лист
      let target=wb.Sheets[wb.SheetNames[0]], tName=wb.SheetNames[0], best=0;
      wb.SheetNames.forEach(n=>{ const s=wb.Sheets[n]; const r=XLSX.utils.decode_range(s['!ref']||'A1:A1'); const cells=(r.e.r-r.s.r+1)*(r.e.c-r.s.c+1); if(cells>best){best=cells; target=s; tName=n;} });

      // читаем как матрицу
      setProgress(40,'Читаю строки');
      const A = XLSX.utils.sheet_to_json(target, {header:1, defval:"", raw:true});
      if(!A.length){ whyEmpty.classList.remove('hidden'); setDiag('Пустой лист.'); hideProgress(); return; }

      const headers = (A[0]||[]).map(h=>normalizeHeader(h));
      const body = A.slice(1);

      // построим индексы колонок
      const need = {
        id: ['id задачи','id'],
        title: ['название задачи','название'],
        deadline: ['дедлайн'],
        board: ['доска'],
        column: ['колонка'],
        project: ['проект'],
        last_msg: ['дата последнего сообщения','последнее сообщение'],
        msgs: ['кол-во сообщений','сообщений'],
        description: ['описание задачи','описание'],
        sticker_priority: ['стикер "приоритет"','приоритет'],
        sticker_stage: ['стикер "этап"','этап'],
        sticker_project: ['стикер "проект"','проект (стикер)'],
        sticker_plan: ['стикер "план сегодня"','план сегодня','план'],
        sticker_fact: ['стикер "факт часов"','факт часов','факт'],
        sticker_category: ['стикер "категория"','категория'],
      };

      const findCol = (variants)=>{
        // точное совпадение / включает / совпадение по ключевым словам
        const cand = headers.map((h,i)=>({h,i}));
        const vs = variants.map(normalizeHeader);
        // 1) точное
        for(const v of vs){ const c = cand.find(c=>c.h===v); if(c) return c.i; }
        // 2) включает
        for(const v of vs){ const c = cand.find(c=>c.h.includes(v)); if(c) return c.i; }
        // 3) ключевые слова (разбиваем по пробелам и проверяем вхождение всех)
        for(const v of vs){
          const words=v.split(' ').filter(Boolean);
          const c = cand.find(c=> words.every(w=>c.h.includes(w)));
          if(c) return c.i;
        }
        return -1;
      };

      const colIdx = {};
      Object.entries(need).forEach(([k,vars])=> colIdx[k] = findCol(vars));

      // диагностика
      const found = Object.entries(colIdx).filter(([_,i])=>i>=0).map(([k,i])=>`${k} → <b>${headers[i]||'?'}</b> (col ${i+1})`).join('<br>');
      const missing = Object.entries(colIdx).filter(([_,i])=>i<0).map(([k,_])=>k).join(', ');
      setDiag(`Лист: <b>${esc(tName)}</b><br>Строк: <b>${body.length}</b>, Колонок: <b>${headers.length}</b><br><br><u>Найдены:</u><br>${found||'—'}<br><br><u>Отсутствуют:</u> ${missing||'—'}`);

      if(colIdx.title<0 && colIdx.id<0){
        whyEmpty.classList.remove('hidden');
        toast('Не найдены колонки ID/Название — проверь xlsx');
        hideProgress(); return;
      }

      setProgress(60,'Готовлю задачи');
      rawTasks = body.map(row => ({
        id: getCell(row,colIdx.id),
        title: getCell(row,colIdx.title),
        deadline: getCell(row,colIdx.deadline),
        board: getCell(row,colIdx.board),
        column: getCell(row,colIdx.column),
        project: getCell(row,colIdx.project),
        last_msg: getCell(row,colIdx.last_msg),
        msgs: getCell(row,colIdx.msgs),
        description: getCell(row,colIdx.description),
        sticker_priority: getCell(row,colIdx.sticker_priority),
        sticker_stage: getCell(row,colIdx.sticker_stage),
        sticker_project: getCell(row,colIdx.sticker_project),
        sticker_plan: getCell(row,colIdx.sticker_plan),
        sticker_fact: getCell(row,colIdx.sticker_fact),
        sticker_category: getCell(row,colIdx.sticker_category),
      }))
      .filter(t => (t.id||t.title) && !/^сумма значений/i.test((t.id||'').toString().trim()));

      if(!rawTasks.length){
        whyEmpty.classList.remove('hidden');
        toast('После фильтрации задач не осталось');
        hideProgress(); return;
      }
      whyEmpty.classList.add('hidden');

      setProgress(78,'Рисую карточки');
      render(rawTasks, isFact, file.name);

      setProgress(100,'Готово ✔');
      hideProgress();
      enableExports(true);
      toast('Коллаж готов. Можно скачать/копировать.');

    }catch(e){
      console.error(e);
      toast('Ошибка обработки файла');
      hideProgress();
    }
  }

  function normalizeHeader(s){
    return (s||'').toString()
      .replace(/[“”«»„‟"']/g,'"')  // все кавычки → "
      .replace(/ё/g,'е')
      .replace(/\s+/g,' ')
      .trim()
      .toLowerCase();
  }
  function getCell(row, idx){ return idx>=0 ? (row[idx]??'') : ''; }

  function detectMode(name=""){ const n=name.toLowerCase(); if(n.includes('сделано сегодня')) return 'fact'; if(n.includes('задачи на сегодня')) return 'plan'; return 'plan'; }

  // Render
  let isFactGlobal=false;
  function render(tasks, isFact, filename){
    isFactGlobal=isFact;
    sumDate.textContent = extractDate(filename);

    viewTasks = applyView(tasks);
    const sp=viewTasks.reduce((a,t)=>a+num(t.sticker_plan),0), sf=viewTasks.reduce((a,t)=>a+num(t.sticker_fact),0);
    sumPlan.textContent = (sp||0).toString().replace('.',','); sumFact.textContent = (sf||0).toString().replace('.',','); sumCount.textContent = viewTasks.length;

    collageTitle.textContent = isFact? 'Сделано сегодня' : 'Задачи на сегодня';
    setColumns(parseInt(colSelect.value||'2',10));

    drawCards(viewTasks, isFact);
    $("#collageWrap").classList.remove("hidden");
    // плавный въезд
    gsap.from($$(".kanban-card", collage),{y:12,opacity:0,duration:.5,stagger:.02,ease:"power2.out"});
  }

  function setColumns(n){
    collage.style.gridTemplateColumns = `repeat(${n}, minmax(0, 1fr))`;
    const widthPerCol = 540;
    collage.style.width = `${Math.max(700, n*widthPerCol + (n-1)*16)}px`;
  }

  function drawCards(items, isFact){
    collage.innerHTML='';
    const compact = density.value==='sm'; const pad = compact? 'p-3 md:p-4' : 'p-4 md:p-5';
    const frag = document.createDocumentFragment();

    items.forEach(t=>{
      const card=document.createElement('article');
      card.className=`kanban-card ${pad} ${isFact? 'fade-dim':''}`;
      card.innerHTML=`
        <div class="flex items-start justify-between gap-3">
          <div class="min-w-0">
            <div class="text-xs text-slate-500 dark:text-slate-400 flex items-center gap-2">
              <span class="pill bg-slate-800 text-white dark:bg-slate-200 dark:text-slate-900">${esc(t.project||'—')}</span>
              ${chip(t.board)} ${chip(t.column)}
            </div>
            <h4 class="mt-2 font-semibold leading-snug">${esc(t.id? t.id+' — ' : '')}${esc(t.title||'Без названия')}</h4>
          </div>
          <div class="text-right shrink-0 space-x-1">
            ${badge(t.sticker_priority, colorForPriority(t.sticker_priority))}
            ${badge(t.sticker_stage, colorForStage(t.sticker_stage))}
          </div>
        </div>
        <div class="mt-3 flex flex-wrap gap-2 text-xs">
          ${t.deadline? `<span class="chip"><b>Дедлайн:</b> ${esc(t.deadline)}</span>`:''}
          ${t.last_msg? `<span class="chip"><b>Последнее сообщение:</b> ${esc(t.last_msg)}</span>`:''}
          ${t.msgs? `<span class="chip"><b>Сообщений:</b> ${esc(t.msgs)}</span>`:''}
          ${t.sticker_plan? `<span class="chip"><b>План:</b> ${esc(t.sticker_plan)} ч</span>`:''}
          ${t.sticker_fact? `<span class="chip"><b>Факт:</b> ${esc(t.sticker_fact)} ч</span>`:''}
          ${t.sticker_category? `<span class="chip"><b>Категория:</b> ${esc(t.sticker_category)}</span>`:''}
        </div>
        ${t.description? `<div class="mt-3 text-[13px] leading-relaxed text-slate-700 dark:text-slate-300">
          ${esc((t.description||'').slice(0, 420))}${t.description.length>420?'…':''}
        </div>`:''}
      `;
      frag.appendChild(card);
    });
    collage.appendChild(frag);
  }

  function chip(text){ return text? `<span class="chip">${esc(text)}</span>`:''; }
  function badge(text, cls){ return text? `<span class="pill ${cls} text-white">${esc(text)}</span>`:''; }
  function colorForPriority(p){ const s=(p||'').toLowerCase(); if(s.includes('пожар')||s.includes('alarm')||s.includes('аларм')) return 'bg-rose-500'; if(s.includes('важно')) return 'bg-amber-500'; return 'bg-slate-400'; }
  function colorForStage(s){ s=(s||'').toLowerCase(); if(s.includes('ждет')||s.includes('очередь')) return 'bg-slate-500'; if(s.includes('в работе')) return 'bg-blue-600'; if(s.includes('выполнено')||s.includes('закончено')) return 'bg-emerald-600'; return 'bg-slate-400'; }
  function extractDate(name=""){ const m=name.match(/сегодня[^\d]*(.+)$/i); return m? m[1].replace(/\.[^.]+$/,'').trim() : '—'; }

  // View controls
  function applyView(list){
    let arr=[...list];
    const q=quickSearch.value.trim().toLowerCase();
    if(q) arr = arr.filter(t => (t.title||'').toLowerCase().includes(q) || (t.id||'').toLowerCase().includes(q));
    switch (sortBy.value){
      case 'priority': arr.sort((a,b)=> priorityRank(a.sticker_priority)-priorityRank(b.sticker_priority)); break;
      case 'deadline': arr.sort((a,b)=> (a.deadline||'').localeCompare(b.deadline||'')); break;
      case 'plan': arr.sort((a,b)=> num(b.sticker_plan)-num(a.sticker_plan)); break;
      case 'fact': arr.sort((a,b)=> num(b.sticker_fact)-num(a.sticker_fact)); break;
    }
    return arr;
  }
  quickSearch.addEventListener('input', ()=>{ viewTasks=applyView(rawTasks); drawCards(viewTasks, isFactGlobal); });
  sortBy.addEventListener('change', ()=>{ viewTasks=applyView(rawTasks); drawCards(viewTasks, isFactGlobal); });
  density.addEventListener('change', ()=> drawCards(viewTasks, isFactGlobal));
  colSelect.addEventListener('change', ()=> setColumns(parseInt(colSelect.value,10)));

  // Export
  function enableExports(v){ btnPNG.disabled=btnPDF.disabled=btnCopy.disabled=!v; }
  async function exportCanvas(){ await new Promise(r=>setTimeout(r,50)); return html2canvas(collage,{ backgroundColor:getComputedStyle(document.body).backgroundColor, scale:2, useCORS:true }); }
  btnPNG.addEventListener('click', async ()=>{ try{ const c=await exportCanvas(); c.toBlob(b=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`${collageTitle.textContent}.png`; a.click(); URL.revokeObjectURL(a.href); }); }catch(e){ console.error(e); toast('PNG: ошибка'); } });
  btnPDF.addEventListener('click', async ()=>{ try{ const c=await exportCanvas(); const img=c.toDataURL('image/png'); const { jsPDF }=window.jspdf; const pdf=new jsPDF({unit:'pt',format:'a4',compress:true}); const pageW=pdf.internal.pageSize.getWidth(), margin=24; const w=pageW - margin*2, h=w*(c.height/c.width); pdf.addImage(img,'PNG',margin,margin,w,h); pdf.save(`${collageTitle.textContent}.pdf`); }catch(e){ console.error(e); toast('PDF: ошибка'); } });
  btnCopy.addEventListener('click', async ()=>{ try{ const c=await exportCanvas(); c.toBlob(async b=>{ try{ await navigator.clipboard.write([new ClipboardItem({'image/png':b})]); toast('Скопировано в буфер ✔'); }catch(_){ toast('Браузер заблокировал буфер — скачай PNG'); } }); }catch(e){ console.error(e); toast('Копирование не удалось'); } });
</script>
</body>
</html>
